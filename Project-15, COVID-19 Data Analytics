# Project15: COVID-19 Data Analytics
# Using MySQL Workbench for creating Database 'covid_db'.

CREATE DATABASE covid_db;
USE covid_db;

# Creating raw data:
CREATE TABLE covid_raw (
    country TEXT,
    date TEXT,
    confirmed INTEGER,
    deaths INTEGER,
    recovered INTEGER
);

# Insert RAW data
INSERT INTO covid_raw VALUES
('USA', '2020-03-01', 30, 1, 0),
('usa', '2020-03-02', 50, 2, 0),
('India', '2020-03-01', 3, 0, 0),
('India', '2020-03-02', 5, 0, 1),
('Brazil', '2020-03-01', 2, 0, NULL),
('Brazil', '2020-03-02', 4, 0, 1),
('USA', '2020-03-02', 50, 2, 0),   -- duplicate
('UK', '2020-03-01', NULL, 0, 0),
('U.K.', '2020-03-02', 10, 1, 0),
('Italy', '2020-03-01', 100, 5, 2),
('Italy', '2020-03-02', 150, 10, 5);

# Create cleaned production table

CREATE TABLE covid_clean (
    country VARCHAR(100),
    date DATE,
    confirmed INTEGER,
    deaths INTEGER,
    recovered INTEGER,
    PRIMARY KEY (country, date)
);

# Insert cleaned data
INSERT INTO covid_clean
SELECT DISTINCT
    TRIM(UPPER(REPLACE(REPLACE(country, '.', ''), ' ', ''))) AS country,
    date,
    confirmed,
    deaths,
    COALESCE(recovered, 0) AS recovered
FROM covid_raw
WHERE confirmed IS NOT NULL;


# Analytical Queries, Top 3 countries by total confirmed cases
SELECT country, SUM(confirmed) AS total_confirmed
FROM covid_clean
GROUP BY country
ORDER BY total_confirmed DESC
LIMIT 3;

# Daily trend of cases (for India)
SELECT date, SUM(confirmed) AS daily_cases
FROM covid_clean
WHERE country = 'INDIA'
GROUP BY date
ORDER BY date;

# Countries with highest deaths-to-confirmed ratio
SELECT country,
       SUM(deaths)*1.0 / SUM(confirmed) AS death_rate
FROM covid_clean
GROUP BY country
ORDER BY death_rate DESC;

# Running total of confirmed cases (window function)
SELECT country,
       date,
       confirmed,
       SUM(confirmed) OVER (PARTITION BY country ORDER BY date) AS running_total
FROM covid_clean
ORDER BY country, date;


# Create views for easy reporting

CREATE VIEW vw_country_summary AS
SELECT country,
       SUM(confirmed) AS total_confirmed,
       SUM(deaths) AS total_deaths,
       SUM(recovered) AS total_recovered
FROM covid_clean
GROUP BY country;
